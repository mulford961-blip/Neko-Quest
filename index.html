<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Neko-Quest — Universal Gamified Productivity HUD</title>

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Orbitron:wght@400;500;600;700&display=swap" rel="stylesheet">

  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          fontFamily: {
            display: ['"Orbitron"', 'ui-serif', 'Georgia'],
            inter: ['Inter', 'ui-sans-serif', 'system-ui']
          },
          colors: {
            violet: {
              glow: '#8B5CF6'
            }
          }
        }
      }
    }
  </script>

  <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
  <script src="https://unpkg.com/framer-motion/dist/framer-motion.umd.js"></script>

  <style>
    :root{
      --bg: #020205;
      --glass: rgba(15, 23, 42, 0.4);
      --glass-border: rgba(255, 255, 255, 0.1);
      --glow: rgba(139, 92, 246, 0.4);
      --text: #f8fafc;
    }

    *{ -webkit-font-smoothing: antialiased; }

    body{
      background: var(--bg);
      color: var(--text);
      overflow-x: hidden;
      font-family: 'Inter', sans-serif;
    }

    /* Nebula Background */
    .nebula-bg {
      position: fixed;
      inset: 0;
      z-index: -1;
      background:
        radial-gradient(circle at 15% 50%, rgba(76, 29, 149, 0.2), transparent 40%),
        radial-gradient(circle at 85% 30%, rgba(14, 165, 233, 0.15), transparent 40%),
        radial-gradient(circle at 50% 80%, rgba(236, 72, 153, 0.15), transparent 40%);
      filter: blur(60px);
      animation: nebulaPulse 15s ease-in-out infinite alternate;
      pointer-events: none;
    }

    @keyframes nebulaPulse {
      0% { opacity: 0.8; transform: scale(1); }
      100% { opacity: 1; transform: scale(1.1); }
    }

    .glass-orb{
      background: rgba(15, 23, 42, 0.3);
      border: 1px solid var(--glass-border);
      box-shadow: 0 0 30px rgba(0, 0, 0, 0.3), inset 0 0 20px rgba(255, 255, 255, 0.02);
      backdrop-filter: blur(12px);
      -webkit-backdrop-filter: blur(12px);
    }

    .orb-float{
      animation: float 8s ease-in-out infinite;
    }

    @keyframes float{
      0%,100%{ transform: translateY(0px); }
      50%{ transform: translateY(-12px); }
    }

    .xp-bar{
      height: 14px;
      background: rgba(255,255,255,0.06);
      border-radius: 999px;
      overflow: hidden;
      position: relative;
    }

    .xp-fill{
      height: 100%;
      background: linear-gradient(90deg, rgba(139,92,246,0.9), rgba(196,181,253,0.95));
      box-shadow: 0 0 16px rgba(139,92,246,0.6);
      transition: width 0.4s ease;
    }

    .checkbox-glow{
      appearance: none;
      width: 18px;
      height: 18px;
      border: 1px solid rgba(139,92,246,0.6);
      border-radius: 6px;
      position: relative;
      display: grid;
      place-items: center;
      background: rgba(255,255,255,0.05);
      box-shadow: 0 0 12px rgba(139,92,246,0.25);
    }

    .checkbox-glow:checked{
      background: rgba(139,92,246,0.9);
      box-shadow: 0 0 18px rgba(139,92,246,0.7);
    }

    .checkbox-glow:checked::after{
      content: '✔';
      font-size: 12px;
      color: #050505;
    }

    .timer-ring{
      width: 180px;
      height: 180px;
      border-radius: 999px;
      background: conic-gradient(#8B5CF6 0deg, rgba(255,255,255,0.1) 0deg 360deg);
      display: grid;
      place-items: center;
      position: relative;
      box-shadow: 0 0 40px rgba(139,92,246,0.45);
    }

    .timer-ring::after{
      content: '';
      position: absolute;
      inset: 12px;
      border-radius: 999px;
      background: rgba(5,5,5,0.85);
      border: 1px solid rgba(139,92,246,0.35);
      box-shadow: inset 0 0 24px rgba(139,92,246,0.25);
    }

    .timer-content{
      position: relative;
      z-index: 1;
      text-shadow: 0 0 18px rgba(139,92,246,0.6);
    }

    .hud-label{
      letter-spacing: 0.4em;
    }

    .floating-light{
      position: absolute;
      border-radius: 999px;
      background: rgba(139,92,246,0.2);
      filter: blur(40px);
      z-index: 1;
      animation: drift 12s ease-in-out infinite;
    }

    @keyframes drift{
      0%,100%{ transform: translateY(0px) translateX(0px); }
      50%{ transform: translateY(-40px) translateX(20px); }
    }

    [contenteditable="true"]:focus{
      outline: none;
      box-shadow: 0 0 0 2px rgba(139,92,246,0.5);
      border-radius: 6px;
    }

    /* Modal Styles */
    .modal-overlay {
      position: fixed;
      inset: 0;
      background: rgba(5, 5, 5, 0.8);
      backdrop-filter: blur(8px);
      z-index: 50;
      display: grid;
      place-items: center;
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.3s ease;
    }
    .modal-overlay.open {
      opacity: 1;
      pointer-events: all;
    }
    .modal-content {
      background: var(--glass);
      border: 1px solid var(--glass-border);
      box-shadow: 0 0 50px rgba(139, 92, 246, 0.2);
      border-radius: 24px;
      padding: 2rem;
      width: 90%;
      max-width: 500px;
      transform: scale(0.95);
      transition: transform 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
    }
    .modal-overlay.open .modal-content {
      transform: scale(1);
    }
    .input-group label {
      display: block;
      font-size: 0.75rem;
      text-transform: uppercase;
      letter-spacing: 0.1em;
      color: #94a3b8;
      margin-bottom: 0.5rem;
    }
    .input-field {
      width: 100%;
      background: rgba(255, 255, 255, 0.05);
      border: 1px solid rgba(255, 255, 255, 0.1);
      border-radius: 8px;
      padding: 0.75rem;
      color: white;
      font-size: 0.9rem;
      transition: all 0.2s;
    }
    .input-field:focus {
      outline: none;
      border-color: var(--glow);
      box-shadow: 0 0 0 2px rgba(139, 92, 246, 0.2);
    }
    .input-field option {
      background: #1a1a20;
    }

    /* Habit Card Styles */
    .habit-card {
      background: rgba(255, 255, 255, 0.03);
      border: 1px solid rgba(255, 255, 255, 0.05);
      border-radius: 16px;
      padding: 1.25rem;
      transition: all 0.3s ease;
      position: relative;
      overflow: hidden;
    }
    .habit-card:hover {
      background: rgba(255, 255, 255, 0.05);
      border-color: rgba(255, 255, 255, 0.1);
    }
    .habit-card.done-full {
      border-color: rgba(139, 92, 246, 0.5);
      background: rgba(139, 92, 246, 0.1);
    }
    .habit-card.done-emergency {
      border-color: rgba(245, 158, 11, 0.5); /* Amber */
      background: rgba(245, 158, 11, 0.1);
    }
    .habit-card.missed {
      border-color: rgba(239, 68, 68, 0.3); /* Red */
      opacity: 0.6;
    }
    .btn-action {
      font-size: 0.75rem;
      text-transform: uppercase;
      letter-spacing: 0.1em;
      padding: 0.5rem 1rem;
      border-radius: 8px;
      transition: all 0.2s;
    }
    .btn-primary {
      background: rgba(139, 92, 246, 0.2);
      border: 1px solid rgba(139, 92, 246, 0.4);
      color: #e2e8f0;
    }
    .btn-primary:hover {
      background: rgba(139, 92, 246, 0.4);
    }
    .btn-secondary {
      background: transparent;
      border: 1px solid rgba(255, 255, 255, 0.1);
      color: #94a3b8;
    }
    .btn-secondary:hover {
      border-color: rgba(255, 255, 255, 0.2);
      color: #e2e8f0;
    }
    .btn-emergency {
      background: rgba(245, 158, 11, 0.1);
      border: 1px solid rgba(245, 158, 11, 0.3);
      color: #fcd34d;
    }
    .btn-emergency:hover {
      background: rgba(245, 158, 11, 0.2);
    }
    .btn-missed {
      border: 1px solid rgba(239, 68, 68, 0.3);
      color: #fca5a5;
    }
    .btn-missed:hover {
      background: rgba(239, 68, 68, 0.1);
    }
    .friction-tag {
      font-size: 0.75rem;
      padding: 0.25rem 0.75rem;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,0.1);
      color: #cbd5e1;
      cursor: pointer;
    }
    .friction-tag.selected {
      background: rgba(139, 92, 246, 0.2);
      border-color: rgba(139, 92, 246, 0.5);
      color: white;
    }

    /* Toggle Switch */
    #emergencyToggle:checked + div {
      background-color: rgba(245, 158, 11, 0.8);
      box-shadow: 0 0 12px rgba(245, 158, 11, 0.4);
    }
    #emergencyToggle:checked + div .toggle-dot {
      transform: translateX(20px);
      background-color: white;
    }

    @keyframes glitch {
      0% { transform: translate(0); }
      20% { transform: translate(-2px, 2px); }
      40% { transform: translate(-2px, -2px); }
      60% { transform: translate(2px, 2px); }
      80% { transform: translate(2px, -2px); }
      100% { transform: translate(0); }
    }
    .glitch {
      animation: glitch 0.3s cubic-bezier(.25, .46, .45, .94) both;
    }

    /* Micro-interactions */
    button, .friction-tag {
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }
    button:hover, .friction-tag:hover {
      transform: scale(1.02);
      filter: brightness(1.2);
    }
    button:active {
      transform: scale(0.95);
    }

    /* Specific overrides for circular buttons to maintain shape */
    #timerReset:hover {
      transform: rotate(90deg) scale(1.1);
    }
  </style>
</head>
<body class="font-inter">
  <div class="nebula-bg"></div>
  <div class="floating-light w-80 h-80 top-10 left-10"></div>
  <div class="floating-light w-96 h-96 bottom-20 right-10"></div>

  <!-- Friction Log Modal -->
  <div id="frictionModal" class="modal-overlay">
    <div class="modal-content">
      <h3 class="font-display text-2xl mb-4">What got in the way?</h3>
      <p class="text-sm text-slate-400 mb-6">Honesty helps the system adapt. Why didn't this happen?</p>

      <div class="flex flex-wrap gap-2 mb-6" id="frictionTags">
        <button class="friction-tag" onclick="frictionModal.toggleTag(this)">Forgot</button>
        <button class="friction-tag" onclick="frictionModal.toggleTag(this)">Too Tired</button>
        <button class="friction-tag" onclick="frictionModal.toggleTag(this)">No Time</button>
        <button class="friction-tag" onclick="frictionModal.toggleTag(this)">Procrastinated</button>
        <button class="friction-tag" onclick="frictionModal.toggleTag(this)">Unexpected Event</button>
      </div>

      <div class="input-group mb-6">
        <label>Notes (Optional)</label>
        <textarea id="frictionNotes" class="input-field" rows="3"></textarea>
      </div>

      <div class="flex gap-3">
        <button onclick="frictionModal.close()" class="flex-1 py-3 rounded-xl border border-white/10 text-slate-300">Cancel</button>
        <button onclick="frictionModal.save()" class="flex-1 py-3 rounded-xl bg-violet-600/80 text-white">Log & Continue</button>
      </div>
    </div>
  </div>

  <!-- Motivation Modal -->
  <div id="motivationModal" class="modal-overlay">
    <div class="modal-content text-center">
      <h3 class="font-display text-2xl mb-4 text-violet-300">Motivation Station</h3>
      <div id="motivationContent" class="space-y-6">
        <!-- Injected via JS -->
      </div>
      <button onclick="motivationModal.close()" class="w-full py-3 mt-8 rounded-xl border border-white/10 text-slate-300 hover:bg-white/5">Back to Quest</button>
    </div>
  </div>

  <!-- System Review Modal -->
  <div id="reviewModal" class="modal-overlay">
    <div class="modal-content">
      <h3 class="font-display text-2xl mb-6">System Diagnostics</h3>

      <div class="space-y-6">
        <div>
          <h4 class="text-xs uppercase tracking-widest text-slate-500 mb-3">Top Friction Points</h4>
          <div id="frictionStats" class="flex flex-wrap gap-2">
            <!-- Injected JS -->
          </div>
        </div>

        <div>
          <h4 class="text-xs uppercase tracking-widest text-slate-500 mb-3">Habit Health</h4>
          <div id="habitHealth" class="space-y-2">
            <!-- Injected JS -->
          </div>
        </div>

        <button onclick="document.getElementById('reviewModal').classList.remove('open')" class="w-full py-3 mt-4 rounded-xl border border-white/10 text-slate-300 hover:bg-white/5">Close Diagnostics</button>
      </div>
    </div>
  </div>

  <!-- Habit Creation Modal -->
  <div id="habitModal" class="modal-overlay">
    <div class="modal-content">
      <h3 class="font-display text-2xl mb-6">Design New Habit</h3>
      <div class="space-y-4">
        <div class="input-group">
          <label>Identity (The "Why")</label>
          <select id="habitCategory" class="input-field">
            <!-- Options injected via JS -->
          </select>
        </div>
        <div class="input-group">
          <label>Behavior (The "What")</label>
          <input type="text" id="habitTitle" class="input-field" placeholder="e.g. Read a book">
        </div>
        <div class="input-group">
          <label>Trigger (The "When")</label>
          <input type="text" id="habitTrigger" class="input-field" placeholder="e.g. After I brush my teeth">
        </div>
        <div class="input-group">
          <label>Emergency Cord (Minimum Viable)</label>
          <input type="text" id="habitEmergency" class="input-field" placeholder="e.g. Read 1 page">
          <p class="text-xs text-slate-500 mt-1">What you'll do on your worst day to keep the streak.</p>
        </div>
        <div class="flex gap-3 mt-8">
          <button id="cancelHabit" class="flex-1 py-3 rounded-xl border border-white/10 text-slate-300 hover:bg-white/5 transition">Cancel</button>
          <button id="saveHabit" class="flex-1 py-3 rounded-xl bg-violet-600/80 hover:bg-violet-600 text-white font-medium transition shadow-lg shadow-violet-900/40">Initialize</button>
        </div>
      </div>
    </div>
  </div>

  <main class="relative z-10 min-h-screen px-6 py-10 flex flex-col items-center gap-10">
    <button id="motivationBtn" class="absolute top-6 left-6 text-xs text-slate-500 uppercase tracking-widest hover:text-violet-400 transition">Motivation</button>

    <div class="absolute top-6 right-6 flex items-center gap-6">
        <label class="flex items-center gap-2 cursor-pointer group">
            <span class="text-xs uppercase tracking-widest text-slate-500 group-hover:text-amber-400 transition">Emergency Mode</span>
            <input type="checkbox" id="emergencyToggle" class="hidden" onchange="toggleEmergencyMode()">
            <div class="w-10 h-5 bg-white/10 rounded-full relative transition-colors duration-300 ease-in-out group-hover:bg-white/20">
                <div class="toggle-dot w-3 h-3 bg-slate-400 rounded-full absolute top-1 left-1 transition-all duration-300 ease-in-out shadow-sm"></div>
            </div>
        </label>
        <button id="reviewBtn" class="text-xs text-slate-500 uppercase tracking-widest hover:text-violet-400 transition">System Status</button>
    </div>

    <header class="text-center space-y-2">
      <p class="text-xs uppercase hud-label text-slate-400">Universal Gamified Productivity HUD</p>
      <h1 class="font-display text-4xl sm:text-5xl text-white">Neko-Quest</h1>
      <p class="text-sm text-slate-400 max-w-xl mx-auto">Design habits with constraints. Use the emergency cord on bad days. Review friction weekly.</p>
    </header>

    <section class="w-full max-w-5xl flex flex-col gap-4">
      <div id="stats" class="flex flex-col lg:flex-row gap-4 justify-center">
        <!-- Stat bars injected here -->
      </div>
    </section>

    <section class="w-full max-w-7xl flex flex-col lg:flex-row gap-6 items-start justify-center">
      <!-- Left: Quest Log -->
      <div class="glass-orb rounded-[32px] p-6 flex-1 w-full lg:max-w-md min-h-[400px]" id="questPanel">
        <div class="flex flex-col gap-4 h-full">
          <div>
            <p class="text-xs uppercase hud-label text-slate-400 mb-1">Quest Log</p>
            <h2 class="font-display text-2xl text-white">Objectives</h2>
          </div>

          <!-- Inline Add Quest (Placeholder for next step) -->
          <div id="addQuestContainer" class="relative">
              <input type="text" id="newQuestInput" placeholder="Initialize new vector..."
                  class="w-full bg-white/5 border border-white/10 rounded-xl px-4 py-3 text-sm text-white placeholder-slate-500 focus:outline-none focus:border-violet-500/50 transition-colors">
              <div class="absolute right-3 top-3 text-xs text-slate-600 font-mono tracking-tight pointer-events-none">ENTER</div>
          </div>

          <div id="questList" class="space-y-3 flex-1 overflow-y-auto custom-scrollbar"></div>
        </div>
      </div>

      <!-- Center: Timer (Focal Point) -->
      <div class="glass-orb rounded-[40px] p-8 flex-[1.2] w-full lg:max-w-lg min-h-[450px] flex flex-col items-center justify-center relative overflow-hidden" id="timerPanel">
        <div class="absolute inset-0 bg-violet-500/5 blur-[100px] rounded-full pointer-events-none"></div>

        <div class="text-center mb-8 relative z-10">
          <p class="text-xs uppercase hud-label text-violet-300 mb-2">System Core</p>
          <h2 class="font-display text-3xl text-white tracking-wide">Focus Engine</h2>
        </div>

        <div class="timer-ring scale-110 mb-8 relative z-10" id="timerRing">
          <div class="timer-content text-center">
            <p class="text-[10px] uppercase tracking-[0.2em] text-slate-400 mb-1">Time Remaining</p>
            <p id="timerDisplay" class="font-display text-4xl font-bold text-white drop-shadow-[0_0_15px_rgba(139,92,246,0.5)]">25:00</p>
          </div>
        </div>

        <div class="flex gap-4 relative z-10">
          <button id="timerToggle" class="px-8 py-3 rounded-full text-xs font-bold uppercase tracking-[0.2em] bg-violet-500/10 border border-violet-500/30 text-violet-200 hover:bg-violet-500/20 hover:scale-105 transition-all duration-300 shadow-[0_0_20px_rgba(139,92,246,0.15)]">Initialize</button>
          <button id="timerReset" class="w-10 h-10 flex items-center justify-center rounded-full border border-white/10 text-slate-400 hover:text-white hover:border-white/30 hover:rotate-90 transition-all duration-300" title="Reset System">
            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M8 3a5 5 0 1 0 4.546 2.914.5.5 0 0 1 .908-.417A6 6 0 1 1 8 2v1z"/><path d="M8 4.466V.534a.25.25 0 0 1 .41-.192l2.36 1.966c.12.1.12.284 0 .384L8.41 4.658A.25.25 0 0 1 8 4.466z"/></svg>
          </button>
        </div>

        <div class="w-full max-w-xs mt-8 relative z-10 opacity-80 hover:opacity-100 transition-opacity">
            <select id="timerQuestSelect" class="w-full bg-black/20 border border-white/5 text-slate-400 text-xs rounded-lg px-3 py-2 focus:outline-none focus:border-violet-500/30">
                <option value="">-- Link to Objective (Optional) --</option>
            </select>
        </div>
      </div>

      <!-- Right: Personal Orbit -->
      <div class="glass-orb rounded-[32px] p-6 flex-1 w-full lg:max-w-md min-h-[400px] flex flex-col" id="orbitPanel">
         <div class="mb-4">
            <p class="text-xs uppercase hud-label text-slate-400 mb-1">Status</p>
            <h2 class="font-display text-2xl text-white">Personal Orbit</h2>
         </div>
         <div class="flex-1 flex items-center justify-center relative" id="personalOrbitContainer">
            <!-- Orbit SVG injected here -->
            <div class="text-slate-500 text-sm">Initializing Orbit...</div>
         </div>
      </div>
    </section>
  </main>

  <script>
    const STORAGE_KEY = 'neko_quest_state_v2';

    // Identity categories (we will calculate scores dynamically)
    const DEFAULT_IDENTITIES = [
      { id: 'cat_1', name: 'Vitality', color: '#10B981' }, // Green
      { id: 'cat_2', name: 'Focus', color: '#8B5CF6' },    // Violet
      { id: 'cat_3', name: 'Creation', color: '#F59E0B' }  // Amber
    ];

    const DEFAULT_STATE = {
      habits: [
        {
          id: 'h_1',
          title: 'Deep Work Session',
          trigger: 'After morning coffee',
          emergency: '5 minutes of planning',
          category: 'cat_2',
          history: {},
          friction_log: []
        },
        {
          id: 'h_2',
          title: 'Morning Movement',
          trigger: 'Before checking phone',
          emergency: 'Stretch for 2 mins',
          category: 'cat_1',
          history: {},
          friction_log: []
        }
      ],
      identities: DEFAULT_IDENTITIES
    };

    const clamp = (num, min, max) => Math.max(min, Math.min(max, num));
    const generateId = () => Math.random().toString(36).substr(2, 9);

    const escapeHtml = (unsafe) => {
      if (!unsafe) return '';
      return unsafe
        .replace(/&/g, "&amp;")
        .replace(/</g, "&lt;")
        .replace(/>/g, "&gt;")
        .replace(/"/g, "&quot;")
        .replace(/'/g, "&#039;");
    };

    const loadState = () => {
      const raw = localStorage.getItem(STORAGE_KEY);
      if (!raw) {
        // Migration check: If v1 exists, we could migrate, but for this exercise we start fresh v2
        return structuredClone(DEFAULT_STATE);
      }
      try {
        const parsed = JSON.parse(raw);
        // Merge with defaults to ensure structure integrity
        return { ...structuredClone(DEFAULT_STATE), ...parsed };
      } catch (err) {
        return structuredClone(DEFAULT_STATE);
      }
    };

    const state = loadState();

    const saveState = () => {
      localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
    };

    let emergencyMode = false;
    window.toggleEmergencyMode = () => {
        emergencyMode = !emergencyMode;
        renderAll();
    };

    const statsEl = document.getElementById('stats');
    const questListEl = document.getElementById('questList');

    const getLast7Days = () => {
      const dates = [];
      for (let i = 0; i < 7; i++) {
        const d = new Date();
        d.setDate(d.getDate() - i);
        dates.push(d.toISOString().split('T')[0]);
      }
      return dates;
    };

    const calculateIdentityScore = (identityId) => {
      const habits = state.habits.filter(h => h.category === identityId && !h.archived);
      if (habits.length === 0) return 0;

      const last7Days = getLast7Days();
      let totalPoints = 0;
      let maxPoints = habits.length * 7;

      habits.forEach(habit => {
        last7Days.forEach(date => {
          const status = habit.history[date];
          if (status === 'full') totalPoints += 1;
          else if (status === 'emergency') totalPoints += 0.5;
        });
      });

      return Math.round((totalPoints / maxPoints) * 100) || 0;
    };

    const renderStats = () => {
      statsEl.innerHTML = state.identities.map((identity, index) => {
        const score = calculateIdentityScore(identity.id);
        const level = Math.floor(score / 20) + 1; // 1 to 5+

        return `
          <div class="glass-orb rounded-[32px] p-5 flex-1 min-w-[260px] hud-panel" style="border-top: 2px solid ${identity.color}40">
            <div class="flex items-center justify-between mb-3">
              <span class="text-xs uppercase hud-label text-slate-400">Identity Protocol</span>
              <span class="text-xs text-slate-500">Lv. ${level}</span>
            </div>
            <div class="flex items-center justify-between">
              <h3 class="font-display text-2xl" style="color:${identity.color}">${escapeHtml(identity.name)}</h3>
              <span class="text-sm text-slate-300">${score}% Consistency</span>
            </div>
            <div class="xp-bar mt-4">
              <div class="xp-fill" style="width: ${score}%; background: ${identity.color}; box-shadow: 0 0 16px ${identity.color}60"></div>
            </div>
          </div>
        `;
      }).join('');
    };

    const getTodayKey = () => new Date().toISOString().split('T')[0];

    const renderQuests = () => {
      const today = getTodayKey();
      // Show pending habits first, then completed ones (optional, or just pending)
      // "One-click completion only... When a quest is completed, it should fade out or 'shimmer' away"
      // This implies we only show pending ones, or we show completed ones differently.
      // Let's show all but sort pending first.

      const activeHabits = state.habits.filter(h => !h.archived);

      if (activeHabits.length === 0) {
        questListEl.innerHTML = `<div class="text-center text-slate-500 py-10 text-sm">No active objectives.<br>Initialize a new vector above.</div>`;
        return;
      }

      questListEl.innerHTML = activeHabits.map(habit => {
        const status = habit.history[today];
        const isDone = status === 'full' || status === 'emergency';
        const safeTitle = escapeHtml(habit.title);

        // Skip rendering completed items if we want them to "disappear" after animation,
        // but for usability, keeping them visible as checked is often better.
        // However, prompt said "fade out... away".
        // Let's keep them in the list but dimmed/crossed out, unless we implement true removal.
        // For now: Render them with 'done' state.

        if (isDone) return ''; // Hiding completed quests to simulate "disappearing"

        return `
          <div class="group flex items-center gap-4 p-4 rounded-xl bg-white/5 border border-white/5 hover:bg-white/10 hover:border-violet-500/30 transition-all cursor-pointer select-none"
               onclick="completeQuest('${habit.id}')">
            <div class="w-5 h-5 rounded-full border border-violet-500/50 group-hover:bg-violet-500/20 group-hover:scale-110 transition-all flex items-center justify-center">
                <div class="w-2 h-2 rounded-full bg-violet-400 opacity-0 group-hover:opacity-100 transition-opacity"></div>
            </div>
            <div class="flex-1">
                <h3 class="text-sm font-medium text-slate-200 group-hover:text-white transition-colors">${safeTitle}</h3>
            </div>
            <div class="opacity-0 group-hover:opacity-100 transition-opacity text-violet-400 text-xs tracking-wider">
                INITIATE
            </div>
          </div>
        `;
      }).join('');
    };

    window.completeQuest = (id) => {
        const today = getTodayKey();
        const habit = state.habits.find(h => h.id === id);
        if (habit) {
            habit.history[today] = 'full';
            saveState();
            triggerConfetti();
            renderAll(); // Re-render will hide it because of `if (isDone) return '';`
        }
    };

    // Add Quest Input Logic
    const newQuestInput = document.getElementById('newQuestInput');
    if (newQuestInput) {
        newQuestInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                const title = newQuestInput.value.trim();
                if (title) {
                    state.habits.push({
                        id: generateId(),
                        title,
                        trigger: 'Daily', // Default
                        emergency: title,
                        category: 'cat_2', // Default to Focus
                        history: {},
                        friction_log: []
                    });
                    saveState();
                    renderAll();
                    newQuestInput.value = '';
                }
            }
        });
    }

    const renderOrbit = () => {
        const today = getTodayKey();
        const activeHabits = state.habits.filter(h => !h.archived);
        const total = activeHabits.length;
        const completed = activeHabits.filter(h => h.history[today] === 'full' || h.history[today] === 'emergency').length;

        const percentage = total === 0 ? 0 : (completed / total) * 100;
        const circumference = 2 * Math.PI * 54; // r=54
        const offset = circumference - (percentage / 100) * circumference;

        const orbitContainer = document.getElementById('personalOrbitContainer');
        if (orbitContainer) {
            orbitContainer.innerHTML = `
                <div class="relative w-48 h-48 flex items-center justify-center">
                    <svg class="w-full h-full transform -rotate-90">
                        <circle cx="50%" cy="50%" r="54" stroke="currentColor" stroke-width="8" fill="transparent" class="text-white/5" />
                        <circle cx="50%" cy="50%" r="54" stroke="currentColor" stroke-width="8" fill="transparent"
                            stroke-dasharray="${circumference}"
                            stroke-dashoffset="${offset}"
                            stroke-linecap="round"
                            class="text-violet-500 drop-shadow-[0_0_10px_rgba(139,92,246,0.5)] transition-all duration-1000 ease-out" />
                    </svg>
                    <div class="absolute inset-0 flex flex-col items-center justify-center">
                        <span class="text-3xl font-display font-bold text-white">${completed}<span class="text-slate-500 text-lg">/${total}</span></span>
                        <span class="text-[10px] uppercase tracking-widest text-violet-300 mt-1">Orbit Sync</span>
                    </div>
                </div>
            `;
        }
    };

    window.promptFriction = (id) => {
      frictionModal.open(id);
    };

    window.retireHabit = (id) => {
      if (confirm('Retire this habit? It will be archived and removed from your daily view.')) {
        const habit = state.habits.find(h => h.id === id);
        if (habit) {
          habit.archived = true;
          saveState();
          renderAll();
        }
      }
    };

    const reviewModal = {
      el: document.getElementById('reviewModal'),
      frictionStats: document.getElementById('frictionStats'),
      habitHealth: document.getElementById('habitHealth'),

      open() {
        this.render();
        this.el.classList.add('open');
      },

      render() {
        // Calculate Friction
        const tagCounts = {};
        state.habits.forEach(h => {
          // Include archived habits in friction stats for learning
          h.friction_log.forEach(entry => {
            entry.reasons.forEach(tag => {
              tagCounts[tag] = (tagCounts[tag] || 0) + 1;
            });
          });
        });

        const sortedTags = Object.entries(tagCounts).sort((a, b) => b[1] - a[1]);

        if (sortedTags.length === 0) {
          this.frictionStats.innerHTML = '<p class="text-sm text-slate-500">No friction recorded yet.</p>';
        } else {
          this.frictionStats.innerHTML = sortedTags.map(([tag, count]) => `
            <div class="flex items-center gap-2 px-3 py-1 bg-white/5 rounded-full border border-white/10">
              <span class="text-sm text-slate-200">${escapeHtml(tag)}</span>
              <span class="text-xs text-violet-400 font-mono">${count}</span>
            </div>
          `).join('');
        }

        // Calculate Habit Health (Misses in last 7 days) - Only active habits
        const last7 = getLast7Days();
        const activeHabits = state.habits.filter(h => !h.archived);

        this.habitHealth.innerHTML = activeHabits.map(h => {
          let misses = 0;
          last7.forEach(d => { if(h.history[d] === 'missed') misses++; });

          if (misses === 0) return '';

          return `
            <div class="flex items-center justify-between p-3 bg-white/5 rounded-lg">
              <span class="text-sm text-slate-300">${escapeHtml(h.title)}</span>
              <span class="text-xs text-red-400">${misses} misses / 7d</span>
            </div>
          `;
        }).filter(Boolean).join('') || '<p class="text-sm text-slate-500">All systems nominal.</p>';
      }
    };

    document.getElementById('reviewBtn').addEventListener('click', () => {
      reviewModal.open();
    });

    const motivationModal = {
      el: document.getElementById('motivationModal'),
      content: document.getElementById('motivationContent'),
      quotes: [
        "Action is the foundational key to all success.",
        "The secret of getting ahead is getting started.",
        "Don't watch the clock; do what it does. Keep going.",
        "You don't have to be great to start, but you have to start to be great.",
        "Small habits, when performed every day, stack up into massive change.",
        "Success is the sum of small efforts, repeated day-in and day-out.",
        "Energy flows where intention goes."
      ],

      open() {
        const randomQuote = this.quotes[Math.floor(Math.random() * this.quotes.length)];
        const topIdentity = state.identities.reduce((prev, current) => {
            return (calculateIdentityScore(prev.id) > calculateIdentityScore(current.id)) ? prev : current
        });

        this.content.innerHTML = `
            <blockquote class="text-xl italic font-display text-white/90">"${randomQuote}"</blockquote>
            <div class="p-4 rounded-xl bg-white/5 border border-white/10 mt-4">
                <p class="text-xs uppercase tracking-widest text-slate-400 mb-2">Identity Reminder</p>
                <p class="text-lg text-violet-200">You are building a <span class="text-white font-bold">${escapeHtml(topIdentity.name)}</span> identity.</p>
            </div>
        `;
        this.el.classList.add('open');
      },

      close() {
        this.el.classList.remove('open');
      }
    };

    document.getElementById('motivationBtn').addEventListener('click', () => motivationModal.open());
    motivationModal.el.addEventListener('click', (e) => { if (e.target === motivationModal.el) motivationModal.close(); });

    const frictionModal = {
      el: document.getElementById('frictionModal'),
      currentHabitId: null,
      selectedTags: [],

      open(id) {
        this.currentHabitId = id;
        this.selectedTags = [];
        this.el.classList.add('open');
        this.el.querySelectorAll('.friction-tag').forEach(t => t.classList.remove('selected'));
        document.getElementById('frictionNotes').value = '';
      },

      close() {
        this.el.classList.remove('open');
      },

      toggleTag(btn) {
        btn.classList.toggle('selected');
        const tag = btn.textContent;
        if (this.selectedTags.includes(tag)) {
          this.selectedTags = this.selectedTags.filter(t => t !== tag);
        } else {
          this.selectedTags.push(tag);
        }
      },

      save() {
        const today = getTodayKey();
        const habit = state.habits.find(h => h.id === this.currentHabitId);
        if (habit) {
          habit.history[today] = 'missed';
          habit.friction_log.push({
            date: today,
            reasons: this.selectedTags,
            notes: document.getElementById('frictionNotes').value
          });
          saveState();
          renderAll();
        }
        this.close();
      }
    };

    const modal = {
      el: document.getElementById('habitModal'),
      category: document.getElementById('habitCategory'),
      title: document.getElementById('habitTitle'),
      trigger: document.getElementById('habitTrigger'),
      emergency: document.getElementById('habitEmergency'),
      cancelBtn: document.getElementById('cancelHabit'),
      saveBtn: document.getElementById('saveHabit'),

      open() {
        this.category.innerHTML = state.identities.map(id =>
          `<option value="${id.id}">${id.name}</option>`
        ).join('');
        this.title.value = '';
        this.trigger.value = '';
        this.emergency.value = '';
        this.el.classList.add('open');
      },

      close() {
        this.el.classList.remove('open');
      },

      save() {
        const title = this.title.value.trim();
        const trigger = this.trigger.value.trim();
        if (!title) return alert('What is the habit?');

        state.habits.push({
          id: generateId(),
          title,
          trigger: trigger || 'Daily',
          emergency: this.emergency.value.trim() || title, // Fallback to full habit if no emergency
          category: this.category.value,
          history: {},
          friction_log: []
        });

        saveState();
        renderAll();
        this.close();
      }
    };

    const setupEvents = () => {
      // Habit Modal
      modal.cancelBtn.onclick = () => modal.close();
      modal.saveBtn.onclick = () => modal.save();
      modal.el.addEventListener('click', (e) => { if (e.target === modal.el) modal.close(); });

      // Friction Modal
      frictionModal.el.addEventListener('click', (e) => { if (e.target === frictionModal.el) frictionModal.close(); });

      // Review Modal
      reviewModal.el.addEventListener('click', (e) => { if (e.target === reviewModal.el) reviewModal.el.classList.remove('open'); });
    };

    // document.getElementById('addQuest').addEventListener('click', () => {
    //   modal.open();
    // });

    const triggerConfetti = () => {
      confetti({
        particleCount: 60,
        spread: 70,
        scalar: 0.8,
        shapes: ['circle', 'square'],
        colors: ['#8B5CF6', '#C4B5FD', '#A78BFA'],
        origin: { x: 0.5, y: 0.7 }
      });
    };

    const timerDisplay = document.getElementById('timerDisplay');
    const timerToggle = document.getElementById('timerToggle');
    const timerReset = document.getElementById('timerReset');
    const timerRing = document.getElementById('timerRing');
    const timerQuestSelect = document.getElementById('timerQuestSelect');

    const TIMER_DURATION = 25 * 60;
    let remaining = TIMER_DURATION;
    let timerId = null;

    const formatTime = (seconds) => {
      const mins = Math.floor(seconds / 60).toString().padStart(2, '0');
      const secs = Math.floor(seconds % 60).toString().padStart(2, '0');
      return `${mins}:${secs}`;
    };

    // For debugging/testing
    window.setTimerRemaining = (secs) => { remaining = secs; updateTimerUI(); };

    const updateTimerUI = () => {
      timerDisplay.textContent = formatTime(remaining);
      const progress = ((TIMER_DURATION - remaining) / TIMER_DURATION) * 360;
      timerRing.style.background = `conic-gradient(#8B5CF6 ${progress}deg, rgba(255,255,255,0.1) ${progress}deg 360deg)`;
    };

    const tickTimer = () => {
      if (remaining <= 0) {
        clearInterval(timerId);
        timerId = null;
        timerToggle.textContent = 'Start';

        // Automated Logging
        const linkedId = timerQuestSelect.value;
        if (linkedId) {
            completeQuest(linkedId);
            timerQuestSelect.value = ""; // Reset
        } else {
            triggerConfetti();
        }
        return;
      }
      remaining -= 1;
      updateTimerUI();
    };

    timerToggle.addEventListener('click', () => {
      if (timerId) {
        clearInterval(timerId);
        timerId = null;
        timerToggle.textContent = 'Start';
      } else {
        timerId = setInterval(tickTimer, 1000);
        timerToggle.textContent = 'Pause';
      }
    });

    timerReset.addEventListener('click', () => {
      clearInterval(timerId);
      timerId = null;
      remaining = TIMER_DURATION;
      timerToggle.textContent = 'Start';
      updateTimerUI();
    });

    const updateTimerSelect = () => {
        const activeHabits = state.habits.filter(h => !h.archived && !h.history[getTodayKey()]);
        const currentVal = timerQuestSelect.value;

        timerQuestSelect.innerHTML = `<option value="">-- Link to Quest (Optional) --</option>` +
            activeHabits.map(h => `<option value="${h.id}">${escapeHtml(h.title)}</option>`).join('');

        if (currentVal && activeHabits.find(h => h.id === currentVal)) {
            timerQuestSelect.value = currentVal;
        }
    };

    const renderAll = () => {
      renderStats();
      renderQuests();
      updateTimerUI();
      updateTimerSelect();
      renderOrbit();
    };

    renderAll();
    setupEvents();

    if (window.framerMotion) {
      const { animate } = window.framerMotion;
      animate('.hud-panel', { opacity: [0, 1], y: [20, 0] }, { duration: 0.9, delay: 0.1, type: 'spring' });
      animate('#questPanel', { opacity: [0, 1], x: [-30, 0] }, { duration: 1, delay: 0.2, type: 'spring' });
      animate('#timerPanel', { opacity: [0, 1], x: [30, 0] }, { duration: 1, delay: 0.2, type: 'spring' });
    }
  </script>
</body>
</html>
