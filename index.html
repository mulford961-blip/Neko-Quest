<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Neko-Quest — Universal Gamified Productivity HUD</title>

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Playfair+Display:wght@500;600;700&display=swap" rel="stylesheet">

  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          fontFamily: {
            display: ['"Playfair Display"', 'ui-serif', 'Georgia'],
            inter: ['Inter', 'ui-sans-serif', 'system-ui']
          },
          colors: {
            violet: {
              glow: '#8B5CF6'
            }
          }
        }
      }
    }
  </script>

  <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
  <script src="https://unpkg.com/framer-motion/dist/framer-motion.umd.js"></script>

  <style>
    :root{
      --bg:#050505;
      --glass:rgba(12, 12, 16, 0.55);
      --glow:#8B5CF6;
      --outline:rgba(139, 92, 246, 0.35);
      --text:rgba(241, 245, 249, 0.95);
    }

    *{ -webkit-font-smoothing: antialiased; }

    body{
      background: var(--bg);
      color: var(--text);
      overflow-x: hidden;
    }

    #starfield{
      position: fixed;
      inset: 0;
      z-index: 0;
    }

    .glass-orb{
      background: radial-gradient(circle at 20% 20%, rgba(139, 92, 246, 0.25), transparent 55%),
        linear-gradient(140deg, rgba(255,255,255,0.08), rgba(255,255,255,0.02));
      background-color: var(--glass);
      border: 1px solid var(--outline);
      box-shadow: 0 0 45px rgba(139, 92, 246, 0.25), inset 0 0 24px rgba(139, 92, 246, 0.15);
      backdrop-filter: blur(20px);
      -webkit-backdrop-filter: blur(20px);
    }

    .orb-float{
      animation: float 8s ease-in-out infinite;
    }

    @keyframes float{
      0%,100%{ transform: translateY(0px); }
      50%{ transform: translateY(-12px); }
    }

    .xp-bar{
      height: 14px;
      background: rgba(255,255,255,0.06);
      border-radius: 999px;
      overflow: hidden;
      position: relative;
    }

    .xp-fill{
      height: 100%;
      background: linear-gradient(90deg, rgba(139,92,246,0.9), rgba(196,181,253,0.95));
      box-shadow: 0 0 16px rgba(139,92,246,0.6);
      transition: width 0.4s ease;
    }

    .cat-orb{
      width: 240px;
      height: 240px;
      border-radius: 999px;
      position: relative;
      overflow: hidden;
    }

    .cat-silhouette{
      width: 120px;
      height: 120px;
      background: linear-gradient(180deg, rgba(139,92,246,0.9), rgba(59,7,100,0.9));
      border-radius: 45% 45% 40% 40%;
      position: relative;
      animation: breathe 5s ease-in-out infinite;
      box-shadow: 0 0 25px rgba(139,92,246,0.6);
    }

    .cat-ear{
      width: 38px;
      height: 38px;
      background: inherit;
      position: absolute;
      top: -16px;
      border-radius: 6px 6px 0 0;
      transform: rotate(45deg);
    }

    .cat-ear.right{ right: 10px; }
    .cat-ear.left{ left: 10px; }

    .cat-orb.level-up{
      animation: levelUp 1s ease;
    }

    @keyframes breathe{
      0%,100%{ transform: scale(1); }
      50%{ transform: scale(1.05); }
    }

    @keyframes levelUp{
      0%{ transform: scale(1); box-shadow: 0 0 25px rgba(139,92,246,0.5); }
      50%{ transform: scale(1.08); box-shadow: 0 0 45px rgba(139,92,246,0.95); }
      100%{ transform: scale(1); box-shadow: 0 0 25px rgba(139,92,246,0.5); }
    }

    .checkbox-glow{
      appearance: none;
      width: 18px;
      height: 18px;
      border: 1px solid rgba(139,92,246,0.6);
      border-radius: 6px;
      position: relative;
      display: grid;
      place-items: center;
      background: rgba(255,255,255,0.05);
      box-shadow: 0 0 12px rgba(139,92,246,0.25);
    }

    .checkbox-glow:checked{
      background: rgba(139,92,246,0.9);
      box-shadow: 0 0 18px rgba(139,92,246,0.7);
    }

    .checkbox-glow:checked::after{
      content: '✔';
      font-size: 12px;
      color: #050505;
    }

    .timer-ring{
      width: 180px;
      height: 180px;
      border-radius: 999px;
      background: conic-gradient(#8B5CF6 0deg, rgba(255,255,255,0.1) 0deg 360deg);
      display: grid;
      place-items: center;
      position: relative;
      box-shadow: 0 0 40px rgba(139,92,246,0.45);
    }

    .timer-ring::after{
      content: '';
      position: absolute;
      inset: 12px;
      border-radius: 999px;
      background: rgba(5,5,5,0.85);
      border: 1px solid rgba(139,92,246,0.35);
      box-shadow: inset 0 0 24px rgba(139,92,246,0.25);
    }

    .timer-content{
      position: relative;
      z-index: 1;
      text-shadow: 0 0 18px rgba(139,92,246,0.6);
    }

    .hud-label{
      letter-spacing: 0.4em;
    }

    .floating-light{
      position: absolute;
      border-radius: 999px;
      background: rgba(139,92,246,0.2);
      filter: blur(40px);
      z-index: 1;
      animation: drift 12s ease-in-out infinite;
    }

    @keyframes drift{
      0%,100%{ transform: translateY(0px) translateX(0px); }
      50%{ transform: translateY(-40px) translateX(20px); }
    }

    [contenteditable="true"]:focus{
      outline: none;
      box-shadow: 0 0 0 2px rgba(139,92,246,0.5);
      border-radius: 6px;
    }

    /* Modal Styles */
    .modal-overlay {
      position: fixed;
      inset: 0;
      background: rgba(5, 5, 5, 0.8);
      backdrop-filter: blur(8px);
      z-index: 50;
      display: grid;
      place-items: center;
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.3s ease;
    }
    .modal-overlay.open {
      opacity: 1;
      pointer-events: all;
    }
    .modal-content {
      background: var(--glass);
      border: 1px solid var(--outline);
      box-shadow: 0 0 50px rgba(139, 92, 246, 0.2);
      border-radius: 24px;
      padding: 2rem;
      width: 90%;
      max-width: 500px;
      transform: scale(0.95);
      transition: transform 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
    }
    .modal-overlay.open .modal-content {
      transform: scale(1);
    }
    .input-group label {
      display: block;
      font-size: 0.75rem;
      text-transform: uppercase;
      letter-spacing: 0.1em;
      color: #94a3b8;
      margin-bottom: 0.5rem;
    }
    .input-field {
      width: 100%;
      background: rgba(255, 255, 255, 0.05);
      border: 1px solid rgba(255, 255, 255, 0.1);
      border-radius: 8px;
      padding: 0.75rem;
      color: white;
      font-size: 0.9rem;
      transition: all 0.2s;
    }
    .input-field:focus {
      outline: none;
      border-color: var(--glow);
      box-shadow: 0 0 0 2px rgba(139, 92, 246, 0.2);
    }
    .input-field option {
      background: #1a1a20;
    }

    /* Habit Card Styles */
    .habit-card {
      background: rgba(255, 255, 255, 0.03);
      border: 1px solid rgba(255, 255, 255, 0.05);
      border-radius: 16px;
      padding: 1.25rem;
      transition: all 0.3s ease;
      position: relative;
      overflow: hidden;
    }
    .habit-card:hover {
      background: rgba(255, 255, 255, 0.05);
      border-color: rgba(255, 255, 255, 0.1);
    }
    .habit-card.done-full {
      border-color: rgba(139, 92, 246, 0.5);
      background: rgba(139, 92, 246, 0.1);
    }
    .habit-card.done-emergency {
      border-color: rgba(245, 158, 11, 0.5); /* Amber */
      background: rgba(245, 158, 11, 0.1);
    }
    .habit-card.missed {
      border-color: rgba(239, 68, 68, 0.3); /* Red */
      opacity: 0.6;
    }
    .btn-action {
      font-size: 0.75rem;
      text-transform: uppercase;
      letter-spacing: 0.1em;
      padding: 0.5rem 1rem;
      border-radius: 8px;
      transition: all 0.2s;
    }
    .btn-primary {
      background: rgba(139, 92, 246, 0.2);
      border: 1px solid rgba(139, 92, 246, 0.4);
      color: #e2e8f0;
    }
    .btn-primary:hover {
      background: rgba(139, 92, 246, 0.4);
    }
    .btn-secondary {
      background: transparent;
      border: 1px solid rgba(255, 255, 255, 0.1);
      color: #94a3b8;
    }
    .btn-secondary:hover {
      border-color: rgba(255, 255, 255, 0.2);
      color: #e2e8f0;
    }
    .btn-emergency {
      background: rgba(245, 158, 11, 0.1);
      border: 1px solid rgba(245, 158, 11, 0.3);
      color: #fcd34d;
    }
    .btn-emergency:hover {
      background: rgba(245, 158, 11, 0.2);
    }
    .btn-missed {
      border: 1px solid rgba(239, 68, 68, 0.3);
      color: #fca5a5;
    }
    .btn-missed:hover {
      background: rgba(239, 68, 68, 0.1);
    }
    .friction-tag {
      font-size: 0.75rem;
      padding: 0.25rem 0.75rem;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,0.1);
      color: #cbd5e1;
      cursor: pointer;
    }
    .friction-tag.selected {
      background: rgba(139, 92, 246, 0.2);
      border-color: rgba(139, 92, 246, 0.5);
      color: white;
    }

    /* Toggle Switch */
    #emergencyToggle:checked + div {
      background-color: rgba(245, 158, 11, 0.8);
      box-shadow: 0 0 12px rgba(245, 158, 11, 0.4);
    }
    #emergencyToggle:checked + div .toggle-dot {
      transform: translateX(20px);
      background-color: white;
    }

    @keyframes glitch {
      0% { transform: translate(0); }
      20% { transform: translate(-2px, 2px); }
      40% { transform: translate(-2px, -2px); }
      60% { transform: translate(2px, 2px); }
      80% { transform: translate(2px, -2px); }
      100% { transform: translate(0); }
    }
    .glitch {
      animation: glitch 0.3s cubic-bezier(.25, .46, .45, .94) both;
    }
  </style>
</head>
<body class="font-inter">
  <canvas id="starfield"></canvas>
  <div class="floating-light w-80 h-80 top-10 left-10"></div>
  <div class="floating-light w-96 h-96 bottom-20 right-10"></div>

  <!-- Friction Log Modal -->
  <div id="frictionModal" class="modal-overlay">
    <div class="modal-content">
      <h3 class="font-display text-2xl mb-4">What got in the way?</h3>
      <p class="text-sm text-slate-400 mb-6">Honesty helps the system adapt. Why didn't this happen?</p>

      <div class="flex flex-wrap gap-2 mb-6" id="frictionTags">
        <button class="friction-tag" onclick="frictionModal.toggleTag(this)">Forgot</button>
        <button class="friction-tag" onclick="frictionModal.toggleTag(this)">Too Tired</button>
        <button class="friction-tag" onclick="frictionModal.toggleTag(this)">No Time</button>
        <button class="friction-tag" onclick="frictionModal.toggleTag(this)">Procrastinated</button>
        <button class="friction-tag" onclick="frictionModal.toggleTag(this)">Unexpected Event</button>
      </div>

      <div class="input-group mb-6">
        <label>Notes (Optional)</label>
        <textarea id="frictionNotes" class="input-field" rows="3"></textarea>
      </div>

      <div class="flex gap-3">
        <button onclick="frictionModal.close()" class="flex-1 py-3 rounded-xl border border-white/10 text-slate-300">Cancel</button>
        <button onclick="frictionModal.save()" class="flex-1 py-3 rounded-xl bg-violet-600/80 text-white">Log & Continue</button>
      </div>
    </div>
  </div>

  <!-- Motivation Modal -->
  <div id="motivationModal" class="modal-overlay">
    <div class="modal-content text-center">
      <h3 class="font-display text-2xl mb-4 text-violet-300">Motivation Station</h3>
      <div id="motivationContent" class="space-y-6">
        <!-- Injected via JS -->
      </div>
      <button onclick="motivationModal.close()" class="w-full py-3 mt-8 rounded-xl border border-white/10 text-slate-300 hover:bg-white/5">Back to Quest</button>
    </div>
  </div>

  <!-- System Review Modal -->
  <div id="reviewModal" class="modal-overlay">
    <div class="modal-content">
      <h3 class="font-display text-2xl mb-6">System Diagnostics</h3>

      <div class="space-y-6">
        <div>
          <h4 class="text-xs uppercase tracking-widest text-slate-500 mb-3">Top Friction Points</h4>
          <div id="frictionStats" class="flex flex-wrap gap-2">
            <!-- Injected JS -->
          </div>
        </div>

        <div>
          <h4 class="text-xs uppercase tracking-widest text-slate-500 mb-3">Habit Health</h4>
          <div id="habitHealth" class="space-y-2">
            <!-- Injected JS -->
          </div>
        </div>

        <button onclick="document.getElementById('reviewModal').classList.remove('open')" class="w-full py-3 mt-4 rounded-xl border border-white/10 text-slate-300 hover:bg-white/5">Close Diagnostics</button>
      </div>
    </div>
  </div>

  <!-- Habit Creation Modal -->
  <div id="habitModal" class="modal-overlay">
    <div class="modal-content">
      <h3 class="font-display text-2xl mb-6">Design New Habit</h3>
      <div class="space-y-4">
        <div class="input-group">
          <label>Identity (The "Why")</label>
          <select id="habitCategory" class="input-field">
            <!-- Options injected via JS -->
          </select>
        </div>
        <div class="input-group">
          <label>Behavior (The "What")</label>
          <input type="text" id="habitTitle" class="input-field" placeholder="e.g. Read a book">
        </div>
        <div class="input-group">
          <label>Trigger (The "When")</label>
          <input type="text" id="habitTrigger" class="input-field" placeholder="e.g. After I brush my teeth">
        </div>
        <div class="input-group">
          <label>Emergency Cord (Minimum Viable)</label>
          <input type="text" id="habitEmergency" class="input-field" placeholder="e.g. Read 1 page">
          <p class="text-xs text-slate-500 mt-1">What you'll do on your worst day to keep the streak.</p>
        </div>
        <div class="flex gap-3 mt-8">
          <button id="cancelHabit" class="flex-1 py-3 rounded-xl border border-white/10 text-slate-300 hover:bg-white/5 transition">Cancel</button>
          <button id="saveHabit" class="flex-1 py-3 rounded-xl bg-violet-600/80 hover:bg-violet-600 text-white font-medium transition shadow-lg shadow-violet-900/40">Initialize</button>
        </div>
      </div>
    </div>
  </div>

  <main class="relative z-10 min-h-screen px-6 py-10 flex flex-col items-center gap-10">
    <button id="motivationBtn" class="absolute top-6 left-6 text-xs text-slate-500 uppercase tracking-widest hover:text-violet-400 transition">Motivation</button>

    <div class="absolute top-6 right-6 flex items-center gap-6">
        <label class="flex items-center gap-2 cursor-pointer group">
            <span class="text-xs uppercase tracking-widest text-slate-500 group-hover:text-amber-400 transition">Emergency Mode</span>
            <input type="checkbox" id="emergencyToggle" class="hidden" onchange="toggleEmergencyMode()">
            <div class="w-10 h-5 bg-white/10 rounded-full relative transition-colors duration-300 ease-in-out group-hover:bg-white/20">
                <div class="toggle-dot w-3 h-3 bg-slate-400 rounded-full absolute top-1 left-1 transition-all duration-300 ease-in-out shadow-sm"></div>
            </div>
        </label>
        <button id="reviewBtn" class="text-xs text-slate-500 uppercase tracking-widest hover:text-violet-400 transition">System Status</button>
    </div>

    <header class="text-center space-y-2">
      <p class="text-xs uppercase hud-label text-slate-400">Universal Gamified Productivity HUD</p>
      <h1 class="font-display text-4xl sm:text-5xl text-white">Neko-Quest</h1>
      <p class="text-sm text-slate-400 max-w-xl mx-auto">Design habits with constraints. Use the emergency cord on bad days. Review friction weekly.</p>
    </header>

    <section class="w-full max-w-5xl flex flex-col gap-4">
      <div id="stats" class="flex flex-col lg:flex-row gap-4 justify-center">
        <!-- Stat bars injected here -->
      </div>
    </section>

    <section class="w-full max-w-6xl flex flex-col lg:flex-row gap-8 items-stretch justify-center">
      <div class="glass-orb orb-float rounded-[40px] p-6 flex-1 min-w-[280px]" id="questPanel">
        <div class="flex items-center justify-between mb-4">
          <div>
            <p class="text-xs uppercase hud-label text-slate-400">Quest Log</p>
            <h2 class="font-display text-2xl">Daily Quests</h2>
          </div>
          <button id="addQuest" class="px-3 py-1 text-xs uppercase tracking-[0.3em] rounded-full border border-violet-400/40 text-violet-200">Add</button>
        </div>
        <div id="questList" class="space-y-3"></div>
      </div>

      <div class="flex flex-col items-center justify-center gap-6 flex-1 min-w-[280px]">
        <div class="glass-orb cat-orb orb-float flex items-center justify-center" id="catOrb">
          <div class="cat-silhouette">
            <span class="cat-ear left"></span>
            <span class="cat-ear right"></span>
          </div>
        </div>
        <p class="text-sm text-slate-300 transition-colors duration-300" id="catStatus">Guardian Cat • XP: 0</p>
      </div>

      <div class="glass-orb rounded-[40px] p-6 flex-1 min-w-[280px]" id="timerPanel">
        <div class="flex items-center justify-between mb-6">
          <div>
            <p class="text-xs uppercase hud-label text-slate-400">Holographic Timer</p>
            <h2 class="font-display text-2xl">Pomodoro Core</h2>
          </div>
        </div>
        <div class="flex flex-col items-center gap-4">
          <div class="timer-ring" id="timerRing">
            <div class="timer-content text-center">
              <p class="text-xs uppercase hud-label text-slate-400">Focus</p>
              <p id="timerDisplay" class="text-3xl font-semibold">25:00</p>
            </div>
          </div>
          <div class="flex gap-3">
            <button id="timerToggle" class="px-4 py-2 rounded-full text-xs uppercase tracking-[0.3em] border border-violet-400/50 text-violet-200">Start</button>
            <button id="timerReset" class="px-4 py-2 rounded-full text-xs uppercase tracking-[0.3em] border border-white/10 text-slate-300">Reset</button>
          </div>

          <div class="w-full mt-2">
            <select id="timerQuestSelect" class="input-field text-xs bg-white/5 border-white/10 text-slate-300 rounded-xl">
                <option value="">-- Link to Quest (Optional) --</option>
            </select>
          </div>
        </div>
      </div>
    </section>
  </main>

  <script>
    const STORAGE_KEY = 'neko_quest_state_v2';

    // Identity categories (we will calculate scores dynamically)
    const DEFAULT_IDENTITIES = [
      { id: 'cat_1', name: 'Vitality', color: '#10B981' }, // Green
      { id: 'cat_2', name: 'Focus', color: '#8B5CF6' },    // Violet
      { id: 'cat_3', name: 'Creation', color: '#F59E0B' }  // Amber
    ];

    const DEFAULT_STATE = {
      catXP: 0,
      habits: [
        {
          id: 'h_1',
          title: 'Deep Work Session',
          trigger: 'After morning coffee',
          emergency: '5 minutes of planning',
          category: 'cat_2',
          history: {},
          friction_log: []
        },
        {
          id: 'h_2',
          title: 'Morning Movement',
          trigger: 'Before checking phone',
          emergency: 'Stretch for 2 mins',
          category: 'cat_1',
          history: {},
          friction_log: []
        }
      ],
      identities: DEFAULT_IDENTITIES
    };

    const clamp = (num, min, max) => Math.max(min, Math.min(max, num));
    const generateId = () => Math.random().toString(36).substr(2, 9);

    const escapeHtml = (unsafe) => {
      if (!unsafe) return '';
      return unsafe
        .replace(/&/g, "&amp;")
        .replace(/</g, "&lt;")
        .replace(/>/g, "&gt;")
        .replace(/"/g, "&quot;")
        .replace(/'/g, "&#039;");
    };

    const loadState = () => {
      const raw = localStorage.getItem(STORAGE_KEY);
      if (!raw) {
        // Migration check: If v1 exists, we could migrate, but for this exercise we start fresh v2
        return structuredClone(DEFAULT_STATE);
      }
      try {
        const parsed = JSON.parse(raw);
        // Merge with defaults to ensure structure integrity
        return { ...structuredClone(DEFAULT_STATE), ...parsed };
      } catch (err) {
        return structuredClone(DEFAULT_STATE);
      }
    };

    const state = loadState();

    const saveState = () => {
      localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
    };

    let emergencyMode = false;
    window.toggleEmergencyMode = () => {
        emergencyMode = !emergencyMode;
        renderAll();
    };

    const statsEl = document.getElementById('stats');
    const questListEl = document.getElementById('questList');
    const catOrb = document.getElementById('catOrb');

    const levelUpCat = () => {
      catOrb.classList.remove('level-up');
      void catOrb.offsetWidth;
      catOrb.classList.add('level-up');
    };

    const getLast7Days = () => {
      const dates = [];
      for (let i = 0; i < 7; i++) {
        const d = new Date();
        d.setDate(d.getDate() - i);
        dates.push(d.toISOString().split('T')[0]);
      }
      return dates;
    };

    const calculateIdentityScore = (identityId) => {
      const habits = state.habits.filter(h => h.category === identityId && !h.archived);
      if (habits.length === 0) return 0;

      const last7Days = getLast7Days();
      let totalPoints = 0;
      let maxPoints = habits.length * 7;

      habits.forEach(habit => {
        last7Days.forEach(date => {
          const status = habit.history[date];
          if (status === 'full') totalPoints += 1;
          else if (status === 'emergency') totalPoints += 0.5;
        });
      });

      return Math.round((totalPoints / maxPoints) * 100) || 0;
    };

    const renderStats = () => {
      // Update global cat XP
      const catStatus = document.getElementById('catStatus');
      if (catStatus) {
        catStatus.textContent = `Guardian Cat • XP: ${state.catXP || 0}`;
      }

      statsEl.innerHTML = state.identities.map((identity, index) => {
        const score = calculateIdentityScore(identity.id);
        const level = Math.floor(score / 20) + 1; // 1 to 5+

        return `
          <div class="glass-orb rounded-[32px] p-5 flex-1 min-w-[260px] hud-panel" style="border-top: 2px solid ${identity.color}40">
            <div class="flex items-center justify-between mb-3">
              <span class="text-xs uppercase hud-label text-slate-400">Identity Protocol</span>
              <span class="text-xs text-slate-500">Lv. ${level}</span>
            </div>
            <div class="flex items-center justify-between">
              <h3 class="font-display text-2xl" style="color:${identity.color}">${escapeHtml(identity.name)}</h3>
              <span class="text-sm text-slate-300">${score}% Consistency</span>
            </div>
            <div class="xp-bar mt-4">
              <div class="xp-fill" style="width: ${score}%; background: ${identity.color}; box-shadow: 0 0 16px ${identity.color}60"></div>
            </div>
          </div>
        `;
      }).join('');
    };

    const getTodayKey = () => new Date().toISOString().split('T')[0];

    const renderQuests = () => {
      const today = getTodayKey();
      const activeHabits = state.habits.filter(h => !h.archived);

      if (activeHabits.length === 0) {
        questListEl.innerHTML = `<div class="text-center text-slate-500 py-10">No active habits. <br>Click 'Add' to design a new one.</div>`;
        return;
      }

      questListEl.innerHTML = activeHabits.map(habit => {
        const status = habit.history[today]; // 'full', 'emergency', 'missed' or undefined
        const identity = state.identities.find(id => id.id === habit.category);
        const color = identity ? identity.color : '#fff';

        // Emergency Mode Logic
        const displayTitle = emergencyMode ? (habit.emergency || habit.title) : habit.title;
        const safeTitle = escapeHtml(displayTitle);
        const isEmergency = emergencyMode && habit.emergency;

        let content = '';
        let cardClass = '';

        if (status === 'full') {
          cardClass = 'done-full';
          content = `
            <div class="flex items-center justify-between">
              <div>
                <h3 class="font-medium text-lg text-white">${safeTitle}</h3>
                <p class="text-xs text-violet-300 tracking-wider uppercase">Completed</p>
              </div>
              <div class="text-violet-400 text-xl">✔</div>
            </div>
          `;
        } else if (status === 'emergency') {
          cardClass = 'done-emergency';
          content = `
            <div class="flex items-center justify-between">
              <div>
                <h3 class="font-medium text-lg text-white">${safeTitle}</h3>
                <p class="text-xs text-amber-300 tracking-wider uppercase">Emergency Drill</p>
              </div>
              <div class="text-amber-400 text-xl">⚠</div>
            </div>
          `;
        } else if (status === 'missed') {
          cardClass = 'missed';
          content = `
            <div class="flex items-center justify-between">
              <div>
                <h3 class="font-medium text-lg text-slate-400 line-through">${safeTitle}</h3>
                <p class="text-xs text-red-300 tracking-wider uppercase">Missed</p>
              </div>
              <div class="text-red-400 text-xl">✕</div>
            </div>
          `;
        } else {
          // Pending state
          content = `
            <div class="flex flex-col gap-3">
              <div class="flex items-start justify-between pointer-events-none">
                <div>
                  <h3 class="font-medium text-lg ${isEmergency ? 'text-amber-300' : 'text-white'}">${safeTitle}</h3>
                  <p class="text-xs text-slate-400 mt-1">When: ${escapeHtml(habit.trigger)}</p>
                </div>
                <div class="w-2 h-2 rounded-full" style="background:${color}; box-shadow: 0 0 10px ${color}"></div>
              </div>

              <div class="text-xs text-slate-500 mt-1 pointer-events-none opacity-50">
                  Tap to complete • Double-tap for options
              </div>

              <div class="struggle-row hidden flex-col gap-2 mt-2" id="struggle-${habit.id}" onclick="event.stopPropagation()">
                <p class="text-xs text-slate-400 mb-1">Emergency Protocol: <span class="text-white">${escapeHtml(habit.emergency)}</span></p>
                <div class="flex gap-2">
                  <button class="btn-action btn-emergency flex-1" onclick="markHabit('${habit.id}', 'emergency')">Do Min. Viable</button>
                  <button class="btn-action btn-missed" onclick="promptFriction('${habit.id}')">Log Miss</button>
                </div>
                <button class="text-xs text-slate-500 hover:text-red-400 mt-2 self-start" onclick="retireHabit('${habit.id}')">Retire this habit</button>
              </div>
            </div>
          `;
        }

        return `
          <div class="habit-card ${cardClass} cursor-pointer hover:bg-white/10 select-none" style="border-left: 3px solid ${color}" onclick="handleHabitClick('${habit.id}')">
            ${content}
          </div>
        `;
      }).join('');
    };

    window.markHabit = (id, status) => {
      const today = getTodayKey();
      const habit = state.habits.find(h => h.id === id);
      if (habit) {
        habit.history[today] = status;
        // Persistence of XP
        if (status === 'full') state.catXP = (state.catXP || 0) + 100;
        if (status === 'emergency') state.catXP = (state.catXP || 0) + 50;

        saveState();
        renderAll();
        if (status === 'full' || status === 'emergency') {
            triggerConfetti();
            triggerGlitch();
        }
      }
    };

    let clickTimeout = null;
    const CLICK_DELAY = 250;

    window.handleHabitClick = (id) => {
      if (clickTimeout) {
        clearTimeout(clickTimeout);
        clickTimeout = null;
        handleHabitDoubleClick(id);
      } else {
        clickTimeout = setTimeout(() => {
          clickTimeout = null;
          handleHabitSingleClick(id);
        }, CLICK_DELAY);
      }
    };

    window.handleHabitSingleClick = (id) => {
        const status = emergencyMode ? 'emergency' : 'full';
        markHabit(id, status);
    };

    window.handleHabitDoubleClick = (id) => {
        const struggleRow = document.getElementById(`struggle-${id}`);
        if (struggleRow) {
            struggleRow.classList.toggle('hidden');
            struggleRow.classList.toggle('flex');
        }
    };

    window.triggerGlitch = () => {
        const cat = document.querySelector('.cat-silhouette');
        if (cat) {
            cat.classList.remove('glitch');
            void cat.offsetWidth;
            cat.classList.add('glitch');
        }

        const status = document.getElementById('catStatus');
        if (status) {
            status.classList.add('text-violet-400', 'font-bold');
            setTimeout(() => status.classList.remove('text-violet-400', 'font-bold'), 500);
        }
    };

    window.promptFriction = (id) => {
      frictionModal.open(id);
    };

    window.retireHabit = (id) => {
      if (confirm('Retire this habit? It will be archived and removed from your daily view.')) {
        const habit = state.habits.find(h => h.id === id);
        if (habit) {
          habit.archived = true;
          saveState();
          renderAll();
        }
      }
    };

    const reviewModal = {
      el: document.getElementById('reviewModal'),
      frictionStats: document.getElementById('frictionStats'),
      habitHealth: document.getElementById('habitHealth'),

      open() {
        this.render();
        this.el.classList.add('open');
      },

      render() {
        // Calculate Friction
        const tagCounts = {};
        state.habits.forEach(h => {
          // Include archived habits in friction stats for learning
          h.friction_log.forEach(entry => {
            entry.reasons.forEach(tag => {
              tagCounts[tag] = (tagCounts[tag] || 0) + 1;
            });
          });
        });

        const sortedTags = Object.entries(tagCounts).sort((a, b) => b[1] - a[1]);

        if (sortedTags.length === 0) {
          this.frictionStats.innerHTML = '<p class="text-sm text-slate-500">No friction recorded yet.</p>';
        } else {
          this.frictionStats.innerHTML = sortedTags.map(([tag, count]) => `
            <div class="flex items-center gap-2 px-3 py-1 bg-white/5 rounded-full border border-white/10">
              <span class="text-sm text-slate-200">${escapeHtml(tag)}</span>
              <span class="text-xs text-violet-400 font-mono">${count}</span>
            </div>
          `).join('');
        }

        // Calculate Habit Health (Misses in last 7 days) - Only active habits
        const last7 = getLast7Days();
        const activeHabits = state.habits.filter(h => !h.archived);

        this.habitHealth.innerHTML = activeHabits.map(h => {
          let misses = 0;
          last7.forEach(d => { if(h.history[d] === 'missed') misses++; });

          if (misses === 0) return '';

          return `
            <div class="flex items-center justify-between p-3 bg-white/5 rounded-lg">
              <span class="text-sm text-slate-300">${escapeHtml(h.title)}</span>
              <span class="text-xs text-red-400">${misses} misses / 7d</span>
            </div>
          `;
        }).filter(Boolean).join('') || '<p class="text-sm text-slate-500">All systems nominal.</p>';
      }
    };

    document.getElementById('reviewBtn').addEventListener('click', () => {
      reviewModal.open();
    });

    const motivationModal = {
      el: document.getElementById('motivationModal'),
      content: document.getElementById('motivationContent'),
      quotes: [
        "Action is the foundational key to all success.",
        "The secret of getting ahead is getting started.",
        "Don't watch the clock; do what it does. Keep going.",
        "You don't have to be great to start, but you have to start to be great.",
        "Small habits, when performed every day, stack up into massive change.",
        "Success is the sum of small efforts, repeated day-in and day-out.",
        "Energy flows where intention goes."
      ],

      open() {
        const randomQuote = this.quotes[Math.floor(Math.random() * this.quotes.length)];
        const topIdentity = state.identities.reduce((prev, current) => {
            return (calculateIdentityScore(prev.id) > calculateIdentityScore(current.id)) ? prev : current
        });

        this.content.innerHTML = `
            <blockquote class="text-xl italic font-display text-white/90">"${randomQuote}"</blockquote>
            <div class="p-4 rounded-xl bg-white/5 border border-white/10 mt-4">
                <p class="text-xs uppercase tracking-widest text-slate-400 mb-2">Identity Reminder</p>
                <p class="text-lg text-violet-200">You are building a <span class="text-white font-bold">${escapeHtml(topIdentity.name)}</span> identity.</p>
            </div>
        `;
        this.el.classList.add('open');
      },

      close() {
        this.el.classList.remove('open');
      }
    };

    document.getElementById('motivationBtn').addEventListener('click', () => motivationModal.open());
    motivationModal.el.addEventListener('click', (e) => { if (e.target === motivationModal.el) motivationModal.close(); });

    const frictionModal = {
      el: document.getElementById('frictionModal'),
      currentHabitId: null,
      selectedTags: [],

      open(id) {
        this.currentHabitId = id;
        this.selectedTags = [];
        this.el.classList.add('open');
        this.el.querySelectorAll('.friction-tag').forEach(t => t.classList.remove('selected'));
        document.getElementById('frictionNotes').value = '';
      },

      close() {
        this.el.classList.remove('open');
      },

      toggleTag(btn) {
        btn.classList.toggle('selected');
        const tag = btn.textContent;
        if (this.selectedTags.includes(tag)) {
          this.selectedTags = this.selectedTags.filter(t => t !== tag);
        } else {
          this.selectedTags.push(tag);
        }
      },

      save() {
        const today = getTodayKey();
        const habit = state.habits.find(h => h.id === this.currentHabitId);
        if (habit) {
          habit.history[today] = 'missed';
          habit.friction_log.push({
            date: today,
            reasons: this.selectedTags,
            notes: document.getElementById('frictionNotes').value
          });
          saveState();
          renderAll();
        }
        this.close();
      }
    };

    const modal = {
      el: document.getElementById('habitModal'),
      category: document.getElementById('habitCategory'),
      title: document.getElementById('habitTitle'),
      trigger: document.getElementById('habitTrigger'),
      emergency: document.getElementById('habitEmergency'),
      cancelBtn: document.getElementById('cancelHabit'),
      saveBtn: document.getElementById('saveHabit'),

      open() {
        this.category.innerHTML = state.identities.map(id =>
          `<option value="${id.id}">${id.name}</option>`
        ).join('');
        this.title.value = '';
        this.trigger.value = '';
        this.emergency.value = '';
        this.el.classList.add('open');
      },

      close() {
        this.el.classList.remove('open');
      },

      save() {
        const title = this.title.value.trim();
        const trigger = this.trigger.value.trim();
        if (!title) return alert('What is the habit?');

        state.habits.push({
          id: generateId(),
          title,
          trigger: trigger || 'Daily',
          emergency: this.emergency.value.trim() || title, // Fallback to full habit if no emergency
          category: this.category.value,
          history: {},
          friction_log: []
        });

        saveState();
        renderAll();
        this.close();
      }
    };

    const setupEvents = () => {
      // Habit Modal
      modal.cancelBtn.onclick = () => modal.close();
      modal.saveBtn.onclick = () => modal.save();
      modal.el.addEventListener('click', (e) => { if (e.target === modal.el) modal.close(); });

      // Friction Modal
      frictionModal.el.addEventListener('click', (e) => { if (e.target === frictionModal.el) frictionModal.close(); });

      // Review Modal
      reviewModal.el.addEventListener('click', (e) => { if (e.target === reviewModal.el) reviewModal.el.classList.remove('open'); });
    };

    document.getElementById('addQuest').addEventListener('click', () => {
      modal.open();
    });

    const triggerConfetti = () => {
      confetti({
        particleCount: 60,
        spread: 70,
        scalar: 0.8,
        shapes: ['circle', 'square'],
        colors: ['#8B5CF6', '#C4B5FD', '#A78BFA'],
        origin: { x: 0.5, y: 0.7 }
      });
    };

    const timerDisplay = document.getElementById('timerDisplay');
    const timerToggle = document.getElementById('timerToggle');
    const timerReset = document.getElementById('timerReset');
    const timerRing = document.getElementById('timerRing');
    const timerQuestSelect = document.getElementById('timerQuestSelect');

    const TIMER_DURATION = 25 * 60;
    let remaining = TIMER_DURATION;
    let timerId = null;

    const formatTime = (seconds) => {
      const mins = Math.floor(seconds / 60).toString().padStart(2, '0');
      const secs = Math.floor(seconds % 60).toString().padStart(2, '0');
      return `${mins}:${secs}`;
    };

    // For debugging/testing
    window.setTimerRemaining = (secs) => { remaining = secs; updateTimerUI(); };

    const updateTimerUI = () => {
      timerDisplay.textContent = formatTime(remaining);
      const progress = ((TIMER_DURATION - remaining) / TIMER_DURATION) * 360;
      timerRing.style.background = `conic-gradient(#8B5CF6 ${progress}deg, rgba(255,255,255,0.1) ${progress}deg 360deg)`;
    };

    const tickTimer = () => {
      if (remaining <= 0) {
        clearInterval(timerId);
        timerId = null;
        timerToggle.textContent = 'Start';

        // Automated Logging
        const linkedId = timerQuestSelect.value;
        if (linkedId) {
            const status = emergencyMode ? 'emergency' : 'full';
            markHabit(linkedId, status);
            timerQuestSelect.value = ""; // Reset
        } else {
            triggerConfetti();
        }
        return;
      }
      remaining -= 1;
      updateTimerUI();
    };

    timerToggle.addEventListener('click', () => {
      if (timerId) {
        clearInterval(timerId);
        timerId = null;
        timerToggle.textContent = 'Start';
      } else {
        timerId = setInterval(tickTimer, 1000);
        timerToggle.textContent = 'Pause';
      }
    });

    timerReset.addEventListener('click', () => {
      clearInterval(timerId);
      timerId = null;
      remaining = TIMER_DURATION;
      timerToggle.textContent = 'Start';
      updateTimerUI();
    });

    const updateTimerSelect = () => {
        const activeHabits = state.habits.filter(h => !h.archived && !h.history[getTodayKey()]);
        const currentVal = timerQuestSelect.value;

        timerQuestSelect.innerHTML = `<option value="">-- Link to Quest (Optional) --</option>` +
            activeHabits.map(h => `<option value="${h.id}">${escapeHtml(h.title)}</option>`).join('');

        if (currentVal && activeHabits.find(h => h.id === currentVal)) {
            timerQuestSelect.value = currentVal;
        }
    };

    const renderAll = () => {
      renderStats();
      renderQuests();
      updateTimerUI();
      updateTimerSelect();
    };

    renderAll();
    setupEvents();

    if (window.framerMotion) {
      const { animate } = window.framerMotion;
      animate('.hud-panel', { opacity: [0, 1], y: [20, 0] }, { duration: 0.9, delay: 0.1, type: 'spring' });
      animate('#questPanel', { opacity: [0, 1], x: [-30, 0] }, { duration: 1, delay: 0.2, type: 'spring' });
      animate('#timerPanel', { opacity: [0, 1], x: [30, 0] }, { duration: 1, delay: 0.2, type: 'spring' });
      animate('#catOrb', { opacity: [0, 1], scale: [0.9, 1] }, { duration: 1.2, delay: 0.3, type: 'spring' });
    }

    const canvas = document.getElementById('starfield');
    const ctx = canvas.getContext('2d');
    let stars = [];

    const resizeCanvas = () => {
      canvas.width = window.innerWidth;
      canvas.height = window.innerHeight;
      stars = Array.from({ length: 140 }, () => ({
        x: Math.random() * canvas.width,
        y: Math.random() * canvas.height,
        radius: Math.random() * 1.4 + 0.2,
        speed: Math.random() * 0.4 + 0.1,
        alpha: Math.random() * 0.7 + 0.2
      }));
    };

    const drawStars = () => {
      ctx.clearRect(0, 0, canvas.width, canvas.height);
      ctx.fillStyle = '#ffffff';
      stars.forEach((star) => {
        star.y += star.speed;
        if (star.y > canvas.height) {
          star.y = 0;
          star.x = Math.random() * canvas.width;
        }
        ctx.globalAlpha = star.alpha;
        ctx.beginPath();
        ctx.arc(star.x, star.y, star.radius, 0, Math.PI * 2);
        ctx.fill();
      });
      ctx.globalAlpha = 1;
      requestAnimationFrame(drawStars);
    };

    window.addEventListener('resize', resizeCanvas);
    resizeCanvas();
    drawStars();
  </script>
</body>
</html>
